<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weaving Circle Drafting Tool vB10</title>
  <link href="https://fonts.googleapis.com/css2?family=Figtree&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Figtree', sans-serif;
      background: #fdfdfd;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #002244;
      color: white;
      text-align: center;
      padding: 10px;
      font-size: 18px;
      position: relative;
    }

    #version {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #ccc;
      font-size: 12px;
    }

    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #controls {
      padding: 10px;
      background: #f6f6f6;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      width: 220px;
      box-sizing: border-box;
    }

    #controls label {
      margin-top: 6px;
    }

    #controls input,
    #controls select,
    #controls button {
      font-size: 14px;
      margin-top: 4px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: 'Figtree', sans-serif;
      width: 100%;
      box-sizing: border-box;
    }

    #controls button {
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }

    #controls button:hover {
      background-color: #0056b3;
    }

    #chart-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 3vw;
      box-sizing: border-box;
      gap: 4vw;
    }

    .chart-box {
      display: none;
      justify-content: center;
      align-items: center;
    }

    .chart-box.active.single {
      flex: 1;
      display: flex;
      max-width: 90vw;
      max-height: 90vh;
    }

    .chart-box.active.double {
      flex: 0 0 calc(50% - 2vw);
      display: flex;
      height: 100%;
    }

    .chart-box table {
      border-collapse: collapse;
    }

    td, th {
      padding: 0;
      text-align: center;
      box-sizing: border-box;
    }

    .grid-cell {
      position: relative;
    }

    .dot {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
    }

    .dot.green {
      background-color: #3CB371;
    }

    .dot.blue {
      background-color: #007BFF;
    }

    .dot.pale {
      background-color: #cce4ff;
    }
  </style>
</head>
<body>
  <header>
    Weaving Circle Drafting Tool
    <span id="version">vB10</span>
  </header>

  <div id="main">
    <div id="controls">
      <label for="epi">EPI:</label>
      <input type="number" id="epi" value="8">
      <label for="ppi">PPI:</label>
      <input type="number" id="ppi" value="34">
      <label for="warps">Width (warps):</label>
      <input type="number" id="warps" value="11">
      <label for="viewMode">Show:</label>
      <select id="viewMode" onchange="generate()">
        <option value="rows" selected>Rows</option>
        <option value="picks">Picks</option>
        <option value="both">Both</option>
      </select>
      <button onclick="generate()">Generate</button>
    </div>

    <div id="chart-container">
      <div class="chart-box" id="rowChartBox"></div>
      <div class="chart-box" id="pickChartBox"></div>
    </div>
  </div>

  <script>
    function calculateDimensions(numRows, warps, epi, ppi, containerWidth, containerHeight) {
      const aspectRatio = (numRows * epi / ppi) / warps;
      const containerAspect = containerHeight / containerWidth;
      let cellWidth, cellHeight;

      if (aspectRatio > containerAspect) {
        cellHeight = containerHeight / numRows;
        cellWidth = cellHeight * (ppi / epi);
      } else {
        cellWidth = containerWidth / warps;
        cellHeight = cellWidth * (epi / ppi);
      }

      const dotSize = 0.75 * Math.min(cellWidth, cellHeight);
      return { cellWidth, cellHeight, dotSize };
    }

    function generate() {
      const epi = +document.getElementById('epi').value;
      const ppi = +document.getElementById('ppi').value;
      const warps = +document.getElementById('warps').value;
      const viewMode = document.getElementById('viewMode').value;

      const picks = Math.floor((ppi / epi) * warps);
      const rows = Math.floor(picks / 2);

      const headerHeight = document.querySelector('header').offsetHeight;
      const controlsHeight = document.getElementById('controls').offsetHeight;
      const availableHeight = window.innerHeight - headerHeight - 20;
      const chartsShown = viewMode === 'both' ? 2 : 1;
      const availableWidth = window.innerWidth - 250 - 40;

      const chartWidth = chartsShown === 2 ? availableWidth / 2 : availableWidth;
      const chartHeight = availableHeight;

      const dimsPicks = calculateDimensions(rows * 2, warps, epi, ppi, chartWidth, chartHeight);
      const dimsRows = {
        cellWidth: dimsPicks.cellWidth,
        cellHeight: dimsPicks.cellHeight * 2,
        dotSize: 0.75 * Math.min(dimsPicks.cellWidth, dimsPicks.cellHeight * 2)
      };

      const fontSizePicks = Math.floor(dimsPicks.cellHeight * 0.6);
      const fontSizeRows = Math.floor(dimsRows.cellHeight * 0.6);

      const rowData = Array.from({ length: rows }, (_, y) =>
        Array.from({ length: warps }, (_, x) => {
          const cx = (warps - 1) / 2;
          const cy = (rows - 1) / 2;
          const rx = warps / 2;
          const ry = rows / 2;
          const dx = (x - cx) / rx;
          const dy = (y - cy) / ry;
          return dx * dx + dy * dy <= 1;
        })
      );

      const pickData = Array.from({ length: rows * 2 }, (_, y) => {
        const row = Math.floor(y / 2);
        const isEvenPick = y % 2 === 0;
        return rowData[row].map((val, x) => {
          if (!val) return null;
          const isWarpUp = (x % 2 === 0) === isEvenPick;
          return isWarpUp ? 'blue' : 'pale';
        });
      });

      function makeTable(data, dims, dotClass, isRow, fontSize) {
        const numRows = data.length;
        const numCols = data[0].length;
        let table = `<table style="font-size:${fontSize}px"><thead><tr><th></th>`;
        for (let x = 0; x < numCols; x++) {
          table += `<th>${x + 1}</th>`;
        }
        table += '</tr></thead><tbody>';
        for (let y = numRows - 1; y >= 0; y--) {
          table += `<tr><th>${y + 1}</th>`;
          for (let x = 0; x < numCols; x++) {
            let borderTop = '1px solid #ccc';
            let borderBottom = '1px solid #ccc';
            if (!isRow) {
              if (y % 2 === 1) borderBottom = '2px solid black';
              if (y % 2 === 0) borderTop = '2px solid black';
            }
            const cell = data[y][x];
            let dot = '';
            if (cell === true) {
              dot = `<div class="dot ${dotClass}" style="width:${dims.dotSize}px;height:${dims.dotSize}px;"></div>`;
            } else if (cell === 'blue' || cell === 'pale') {
              dot = `<div class="dot ${cell}" style="width:${dims.dotSize}px;height:${dims.dotSize}px;"></div>`;
            }
            table += `<td class="grid-cell" style="width:${dims.cellWidth}px;height:${dims.cellHeight}px;border-left:1px solid #ccc;border-right:1px solid #ccc;border-top:${borderTop};border-bottom:${borderBottom};">${dot}</td>`;
          }
          table += '</tr>';
        }
        table += '</tbody></table>';
        return table;
      }

      const rowBox = document.getElementById('rowChartBox');
      const pickBox = document.getElementById('pickChartBox');
      rowBox.className = 'chart-box';
      pickBox.className = 'chart-box';

      if (viewMode === 'rows') {
        rowBox.classList.add('active', 'single');
        rowBox.innerHTML = makeTable(rowData, dimsRows, 'green', true, fontSizeRows);
        pickBox.innerHTML = '';
      } else if (viewMode === 'picks') {
        pickBox.classList.add('active', 'single');
        pickBox.innerHTML = makeTable(pickData, dimsPicks, '', false, fontSizePicks);
        rowBox.innerHTML = '';
      } else {
        rowBox.classList.add('active', 'double');
        pickBox.classList.add('active', 'double');
        rowBox.innerHTML = makeTable(rowData, dimsRows, 'green', true, fontSizeRows);
        pickBox.innerHTML = makeTable(pickData, dimsPicks, '', false, fontSizePicks);
      }
    }

    window.onload = generate;
    window.onresize = () => {
      clearTimeout(window._resizeTimer);
      window._resizeTimer = setTimeout(generate, 200);
    };
  </script>
</body>
</html>
